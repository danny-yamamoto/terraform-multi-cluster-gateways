---
title: "Awesome Multi-cluster Gateways"
emoji: "ðŸšª"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["gke", "gateway", "ingress", "googlecloud", "k6"]
published: false
---
[Retail AI Adventurers Advent Calendar 2023 ã®æŠ•ç¨¿ã§ã™ã€‚](https://qiita.com/advent-calendar/2023/rai-adventurers)

https://qiita.com/advent-calendar/2023/rai-adventurers

[Retail AI](https://www.retail-ai.jp) ã¯ã€[ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã‚«ãƒ³ãƒ‘ãƒ‹ãƒ¼](https://www.trial-net.co.jp) ã‚’è»¸ã¨ã—ãŸå°å£²ã«ãŠã‘ã‚‹ãŠå®¢æ§˜ã®è²·ã„ç‰©ä½“é¨“ã®å‘ä¸Šã‚’ç›®æŒ‡ã™ä¼æ¥­ã§ã™ã€‚

ã“ã®æŠ•ç¨¿ã§ã¯ã€ç§ã®æœ¬è·ã® Site Reliability Engineering[^8] ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚

é¡Œæã¯ã€Multi-cluster Gatewayï¼ˆGatewayï¼‰ã§ã™ã€‚æœ€è¿‘ã€GA[^7] ã«ãªã£ãŸã®ã§ã€æ¤œè¨¼ã—ã¾ã™ã€‚

https://gateway-api.sigs.k8s.io

https://cloud.google.com/blog/products/containers-kubernetes/multi-cluster-gateway-controller-for-gke-is-now-ga/?hl=en

Gateway ã‚’ç°¡å˜ã«èª¬æ˜Žã™ã‚‹ã¨ã€Œæ–°è£½å“ãŒå‡ºã¦ã€ã“ã‚Œã¾ã§ã‚ˆã‚Šä¾¿åˆ©ã«ãªã£ãŸã€ã¨ã„ã†æ„Ÿã˜ã®æ©Ÿèƒ½ã§ã™ã€‚

ï¼ˆMac ã‚’ update ã™ã‚‹ã¨è¿½åŠ ã•ã‚Œã‚‹æ©Ÿèƒ½ã®ã‚ˆã†ãªã€‚æ°—ã«ã—ãªã„äººã«ã¨ã£ã¦ã¯ã‚ã£ã¦ã‚‚ç„¡ãã¦ã‚‚å¤‰ã‚ã‚‰ãªã„ã‚ˆã†ãªã€‚ï¼‰


ã•ã‚‰ã«è©³ã—ãè¦‹ãŸã„æ–¹ã¯èª­ã¿ç¶šã‘ã¦ãã ã•ã„ã€‚

---

Gateway ã«ã¤ã„ã¦ã€ã‚‚ã†å°‘ã—è©³ã—ãèª¬æ˜Žã™ã‚‹ã¨ã€External Application Load Balancer `Ingress` ã§æˆ‘æ…¢ã—ã¦ã„ãŸ Ops ã‚’æ”¹å–„ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://cloud.google.com/kubernetes-engine/docs/concepts/ingress?hl=ja

å³ï¼šæ–°è£½å“ç™ºå£²å‰
å·¦ï¼šæ–°è£½å“ç™ºå£²å¾Œ

`Ingress` ãŒ3ã¤ã®å½¹å‰²ã«åˆ†ã‹ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ã“ã†ãªã‚‹ã“ã¨ã§ã€å½¹å‰²åˆ†æ‹…ã‚’è¡Œãˆã¾ã™ã€‚Developer / Infrastructure Engineer / SRE ã®ã€‚

ãã‚ŒãŒä¸€ç•ªå¬‰ã—ã„ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚åœ°å‘³ã«ã€‚

```mermaid
graph TD;
    classDef updates fill:#f96

    client3[Client]
    store1[Store API]
    gatewayclass[GatewayClass]
    gateway[Gateway]
    httproute[HTTPRoute]
    subgraph gateways[Gateway]
      gatewayclass --> gateway
      gateway --> httproute
    end
    client3-->gatewayclass
    httproute-->store1

    client2[Client]
    ingress[Ingress]
    store2[Store API]
    client2 --> ingress
    ingress:::updates --> store2
```

ãã‚Œã§ã¯ã€Multi-cluster Gateway ã®å‹•ãã‚’ç¢ºèªã—ã¾ã™ã€‚

## Create a Multi-cluster Gateway and Cluster
å…¬å¼ã® docs[^3][^4] ã§å•é¡Œãªã setup ã§ãã¾ã™ã€‚
æ°—ã‚’ã¤ã‘ã‚‹ã®ã¯ã€`Multi` Region[^6] ã§ã‚ã‚‹ã“ã¨ã§ã™ã€‚`Single` Region Multi-cluster ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ç°¡å˜ã«å›³ã«ã™ã‚‹ã¨ã€ã“ã†è¨€ã†æ„Ÿã˜ã§ã™ã€‚
`Fleet`[^5] ãŒå‡ºã¦ãã‚‹æ™‚ç‚¹ã§å«Œãªæ„Ÿã˜ã¯ã—ã¾ã™ã€‚å€‹äººçš„ã«ã€‚

```mermaid
graph TD;
    client[Client]
    gateway[Gateway]
    subgraph fleet [Fleet]
        subgraph one [West Cluster]
        store1[Store API]
        end
        subgraph two [East Cluster]
        store2[Store API]
        end
    end
    client-->gateway;
    gateway-->store1
    gateway-->store2
```

https://github.com/danny-yamamoto/terraform-multi-cluster-gateways/blob/main/example/README.md

## Distribute traffic
traffic åˆ†æ•£ãŒã©ã†ãªã‚‹ã®ã‹ç¢ºèªã—ã¾ã™ã€‚

æ¤œè¨¼ã«ç”¨ã„ã‚‹ã®ã¯ `k6`[^2] ã§ã™ã€‚

æº–å‚™ã¯æ¬¡ã®é€šã‚Šã€‚
1. VS Code ã« k6 ã® extension ã‚’è¿½åŠ ã™ã‚‹ã€‚
1. script ã‚’æº–å‚™ã™ã‚‹ã€‚
1. k6 ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

### Add a VS Code extension

https://github.com/danny-yamamoto/terraform-multi-cluster-gateways/blob/6aa42a310cc6193f08f55e583917072a5a49b550/.devcontainer/devcontainer.json#L10

### Create a script
`Store` API ã® Endpoint `http://store.example.com` ã«å¯¾ã—ã¦è² è·ã‚’ã‹ã‘ã¾ã™ã€‚
```js: test.js
import http from 'k6/http';
import { sleep } from 'k6';

export default function () {
  http.get('http://store.example.com');
  sleep(1);
}
```

### Execute k6
`Store` API ã®å˜ä¸€ã® Endpoint ã«ä»¥ä¸‹ã®æ¡ä»¶ã§ traffic ã‚’æµã—ã¾ã™ã€‚
- `--vus` : ä¸¦åˆ—å®Ÿè¡Œæ•° 30
- `--duration` : 60ç§’é–“
```bash
vscode âžœ /workspaces/terraform-multi-cluster-gateways (main) $ k6 run --vus 30 --duration 60s test.js 

          /\      |â€¾â€¾| /â€¾â€¾/   /â€¾â€¾/   
     /\  /  \     |  |/  /   /  /    
    /  \/    \    |     (   /   â€¾â€¾\  
   /          \   |  |\  \ |  (â€¾)  | 
  / __________ \  |__| \__\ \_____/ .io

  execution: local
     script: test.js
     output: -

  scenarios: (100.00%) 1 scenario, 30 max VUs, 1m30s max duration (incl. graceful stop):
           * default: 30 looping VUs for 1m0s (gracefulStop: 30s)


     data_received..................: 849 kB 14 kB/s
     data_sent......................: 129 kB 2.1 kB/s
     http_req_blocked...............: avg=725.74Âµs min=709ns    med=5.89Âµs   max=38.68ms  p(90)=15.41Âµs  p(95)=24.4Âµs  
     http_req_connecting............: avg=605.88Âµs min=0s       med=0s       max=32.63ms  p(90)=0s       p(95)=0s      
     http_req_duration..............: avg=152.26ms min=112.94ms med=128.9ms  max=500.83ms p(90)=209.28ms p(95)=245.09ms
       { expected_response:true }...: avg=152.26ms min=112.94ms med=128.9ms  max=500.83ms p(90)=209.28ms p(95)=245.09ms
     http_req_failed................: 0.00%  âœ“ 0         âœ— 1572
     http_req_receiving.............: avg=622.21Âµs min=6.45Âµs   med=106.81Âµs max=114.73ms p(90)=1.25ms   p(95)=1.83ms  
     http_req_sending...............: avg=46.68Âµs  min=2.58Âµs   med=22.43Âµs  max=4.61ms   p(90)=76.31Âµs  p(95)=146.04Âµs
     http_req_tls_handshaking.......: avg=0s       min=0s       med=0s       max=0s       p(90)=0s       p(95)=0s      
     http_req_waiting...............: avg=151.59ms min=112.6ms  med=127.89ms max=500.43ms p(90)=208.39ms p(95)=244.85ms
     http_reqs......................: 1572   25.721444/s
     iteration_duration.............: avg=1.15s    min=1.11s    med=1.13s    max=1.53s    p(90)=1.21s    p(95)=1.24s   
     iterations.....................: 1572   25.721444/s
     vus............................: 2      min=2       max=30
     vus_max........................: 30     min=30      max=30


running (1m01.1s), 00/30 VUs, 1572 complete and 0 interrupted iterations
default âœ“ [======================================] 30 VUs  1m0s
vscode âžœ /workspaces/terraform-multi-cluster-gateways (main) $ 
```

### Result Confirmation
Cloud Monitoring ã® Log Analytics[^11] ã§ container ã® log ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¦ã¿ã¾ã™ã€‚

```sql
SELECT
  JSON_VALUE(resource.labels.location) AS cluster_location,
  COUNT(*) AS cnt
FROM
  `sandbox-mc-gateway.global._Default._AllLogs`
WHERE
  resource.type="k8s_container"
  AND timestamp >= TIMESTAMP("2023-11-30 13:03:00", "Asia/Tokyo")
  AND timestamp <= TIMESTAMP("2023-11-30 13:06:00", "Asia/Tokyo")
GROUP BY
  cluster_location
```

ä»¥ä¸‹ãŒå®Ÿè¡Œçµæžœã§ã™ã€‚
ä¸€å¿œã€æŒ¯ã‚Šåˆ†ã‘ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚west å´ã«å¯„ã£ã¦ã¾ã™ãŒã€‚
```bash
[
  {
    "id": "ROW_fcde01ba_0000000000",
    "cluster_location": "us-west1-a",
    "cnt": 15369
  },
  {
    "id": "ROW_fcde01ba_0000000001",
    "cluster_location": "us-east1-b",
    "cnt": 583
  }
]
```

Terraform[^9] ã§ code åŒ–ã—ã‚ˆã†ã¨æ€ã„ã¾ã—ãŸãŒã€æ­£æœˆã®æš‡ãªæ™‚ã«ã‚„ã‚Šã¾ã™ã€‚

ä»Šã®æ°—åˆ†ã¯ Rust[^10] ã«å…¨æŒ¯ã‚Šã®ãŸã‚ã€‚

Gateway ã«é–¢ã™ã‚‹æ¤œè¨¼ã¯ä»¥ä¸Šã§ã™ã€‚

ã“ã®æŠ•ç¨¿ã‚’ã¿ã¦ä½•ã‹å¾—ã‚‰ã‚ŒãŸæ–¹ã¯ã€ã„ã„ã­ â¤ï¸ ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

ãã‚Œã§ã¯ã€æ¬¡å›žã®ã‚¢ãƒ‰ã‚«ãƒ¬ã§ãŠä¼šã„ã—ã¾ã—ã‚‡ã†ã€‚ðŸ‘‹

æ˜Žæ—¥ã¯ã€ [@Carol_fan](https://qiita.com/Carol_fan) ã•ã‚“ã®æŠ•ç¨¿ã§ã™ã€‚ãŠæ¥½ã—ã¿ã«ï¼

## BTW
Multi-cluster Gateway ã§ã€Œã§ããªã„ã“ã¨ã€ã‚‚ã‚ã‚‹ã‚ˆã†ã§ã™ã€‚

ä¾‹ãˆã°ã€è¤‡æ•° Project ã® Cluster ã«ã¯ã€ã¾ã å¯¾å¿œã—ã¦ã„ãªã„ã§ã™ã€‚èªè­˜ã«èª¤ã‚ŠãŒãªã‘ã‚Œã°ã€‚[^1]

ã¨ã¯è¨€ãˆã€ç¾è·ã§ã¯ã€åŸºæœ¬çš„ã«ã¯ã€å˜ä¸€ Project ã§ã‚ã‚‹ãŸã‚ã€å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚


[^1]: https://cloud.google.com/kubernetes-engine/docs/how-to/enabling-multi-cluster-gateways#restrictions_and_limitations
[^2]: https://k6.io/docs/
[^3]: https://cloud.google.com/kubernetes-engine/docs/how-to/deploying-multi-cluster-gateways
[^4]: https://cloud.google.com/kubernetes-engine/docs/how-to/enabling-multi-cluster-gateways
[^5]: Fleet ã¯ã€è¤‡æ•°ã® Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ä¸€å…ƒçš„ã«ç®¡ç†ã—ã€æ“ä½œã™ã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚
[^6]: Region ã¯ã€Google Cloud ã® Resource ã¨ Service ãŒç‰©ç†çš„ã«é…ç½®ã•ã‚Œã¦ã„ã‚‹åœ°ç†çš„ãªå ´æ‰€ã‚’æŒ‡ã—ã¾ã™ã€‚æ±äº¬ã€å¤§é˜ªãªã©ã€‚
[^7]: ä¸€èˆ¬æä¾›ã€‚
[^8]: Site Reliability Engineeringï¼ˆSREï¼‰ã¯ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã®åŽŸå‰‡ã¨ãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’ã‚·ã‚¹ãƒ†ãƒ é‹ç”¨ã«é©ç”¨ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€å¤§è¦æ¨¡ãªã‚·ã‚¹ãƒ†ãƒ ã®ä¿¡é ¼æ€§ã€å¯ç”¨æ€§ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã€åŠ¹çŽ‡æ€§ã‚’å‘ä¸Šã•ã›ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã™ã€‚
[^9]: Terraformã¯ã€HashiCorpã«ã‚ˆã£ã¦é–‹ç™ºã•ã‚ŒãŸã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒ¼ãƒ»ã‚¢ã‚ºãƒ»ã‚³ãƒ¼ãƒ‰ï¼ˆInfrastructure as Codeã€IaCï¼‰ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆAWSã€Google Cloud Platformã€Microsoft Azureãªã©ï¼‰ã€ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ãƒªã‚½ãƒ¼ã‚¹ã€ãŠã‚ˆã³ãã®ä»–å¤šãã®å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚„APIã‚’å«ã‚€ã€åºƒç¯„ãªã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒ¼ã®è¨­å®šã¨ç®¡ç†ã‚’è‡ªå‹•åŒ–ã™ã‚‹ãŸã‚ã«åºƒãä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
[^10]: Rust ã¯ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã€å®‰å…¨æ€§ã€ä¸¦è¡Œå‡¦ç†ã«é‡ç‚¹ã‚’ç½®ã„ãŸã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªžã§ã™ã€‚
[^11]: Log Analytics ã¯ã€Google Cloud ä¸Šã®ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’åŽé›†ã€åˆ†æžã€å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã—ã¦ã€ç‰¹å®šã®ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’æ·±ãæŽ˜ã‚Šä¸‹ã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
