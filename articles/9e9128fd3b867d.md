---
title: "Awesome Multi-cluster Gateways"
emoji: "ðŸ†š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["gke", "gateway", "ingress", "googlecloud", "k6"]
published: false
---
[Retail AI Adventurers Advent Calendar 2023 ã®æŠ•ç¨¿ã§ã™ã€‚](https://qiita.com/advent-calendar/2023/rai-adventurers)

[Retail AI](https://www.retail-ai.jp) ã¯ã€[ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã‚«ãƒ³ãƒ‘ãƒ‹ãƒ¼](https://www.trial-net.co.jp) ã‚’è»¸ã¨ã—ãŸå°å£²ã«ãŠã‘ã‚‹ãŠå®¢æ§˜ã®è²·ã„ç‰©ä½“é¨“ã®å‘ä¸Šã‚’ç›®æŒ‡ã™ä¼æ¥­ã§ã™ã€‚

ã“ã®æŠ•ç¨¿ã§ã¯ã€ç§ã®æœ¬è·ã® Site Reliability Engineering ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚

é¡Œæã¯ã€Multi-cluster Gatewayï¼ˆGatewayï¼‰ã§ã™ã€‚æœ€è¿‘ã€GA ã«ãªã£ãŸã®ã§ã€æ¤œè¨¼ã—ã¾ã™ã€‚

https://gateway-api.sigs.k8s.io

https://cloud.google.com/blog/products/containers-kubernetes/multi-cluster-gateway-controller-for-gke-is-now-ga/?hl=en

Gateway ã‚’ç°¡å˜ã«è¨€ã†ã¨ã€Œæ–°è£½å“ãŒå‡ºã¦ã€ã“ã‚Œã¾ã§ã‚ˆã‚Šä¾¿åˆ©ã«ãªã£ãŸã€ã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚Mac ã‚’ update ã™ã‚‹ã¨æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚Œã‚‹ã‚ˆã†ãªã€‚æ°—ã«ã—ãªã„äººã«ã¨ã£ã¦ã¯ã‚ã£ã¦ã‚‚ç„¡ãã¦ã‚‚å¤‰ã‚ã‚‰ãªã„ã‚ˆã†ãªã€‚

ã•ã‚‰ã«è©³ã—ãè¦‹ãŸã„æ–¹ã¯èª­ã¿ç¶šã‘ã¦ãã ã•ã„ã€‚

---

Gateway ã«ã¤ã„ã¦ã€ã‚‚ã†å°‘ã—è©³ã—ãèª¬æ˜Žã™ã‚‹ã¨ã€`Ingress` ã§æˆ‘æ…¢ã—ã¦ã„ãŸ Ops ã‚’æ”¹å–„ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãŸã ã—ã€Œã§ããªã„ã“ã¨ã€ã‚‚ã‚ã‚‹ã‚ˆã†ã§ã™ã€‚

ä¾‹ãˆã°ã€è¤‡æ•° Project ã® Cluster ã«ã¯ã€ã¾ã å¯¾å¿œã—ã¦ã„ãªã„ã§ã™ã€‚èªè­˜ã«èª¤ã‚ŠãŒãªã‘ã‚Œã°ã€‚[^1]

ã¨ã¯è¨€ãˆã€ç¾è·ã§ã¯ã€åŸºæœ¬çš„ã«ã¯ã€å˜ä¸€ Project ã§ã‚ã‚‹ãŸã‚ã€å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

Multi-cluster Gateway ã®å‹•ãã‚’ç¢ºèªã—ã¾ã™ã€‚

## Create Multi-cluster Gateway
å…¬å¼ã® docs[^3][^4] ã§å•é¡Œãªã setup ã§ãã¾ã—ãŸã€‚
æ°—ã‚’ã¤ã‘ã‚‹ã®ã¯ã€`Multi` region ã§ã‚ã‚‹ã“ã¨ã§ã™ã€‚`Single` region Multi-cluster ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ç°¡å˜ã«å›³ã«ã™ã‚‹ã¨ã€ã“ã†è¨€ã†æ„Ÿã˜ã§ã™ã€‚
`Fleet` ãŒå‡ºã¦ãã‚‹æ™‚ç‚¹ã§å«Œãªæ„Ÿã˜ã¯ã—ã¾ã™ã€‚å€‹äººçš„ã«ã€‚

```mermaid
graph TD;
    client[Client]
    gateway[Gateway]
    subgraph fleet [Fleet]
        subgraph one [west cluster]
        store1[Store]
        end
        subgraph two [east cluster]
        store2[Store]
        end
    end
    client-->gateway;
    gateway-->store1
    gateway-->store2
```

https://github.com/danny-yamamoto/terraform-multi-cluster-gateways/blob/main/example/README.md

## Distribute traffic
traffic åˆ†æ•£ãŒã©ã†ãªã‚‹ã®ã‹ç¢ºèªã—ã¾ã™ã€‚

æ¤œè¨¼ã«ç”¨ã„ã‚‹ã®ã¯ `k6`[^2] ã§ã™ã€‚

æº–å‚™ã¯æ¬¡ã®é€šã‚Šã€‚
1. VS Code ã« k6 ã® extension ã‚’è¿½åŠ ã™ã‚‹ã€‚
1. script ã‚’æº–å‚™ã™ã‚‹ã€‚
1. k6 ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

### VS Code extension

https://github.com/danny-yamamoto/terraform-multi-cluster-gateways/blob/6aa42a310cc6193f08f55e583917072a5a49b550/.devcontainer/devcontainer.json#L10

### Script
```js: test.js
import http from 'k6/http';
import { sleep } from 'k6';

export default function () {
  http.get('http://store.example.com');
  sleep(1);
}
```

### Execute k6
```bash
vscode âžœ /workspaces/terraform-multi-cluster-gateways (main) $ k6 run --vus 30 --duration 60s test.js 

          /\      |â€¾â€¾| /â€¾â€¾/   /â€¾â€¾/   
     /\  /  \     |  |/  /   /  /    
    /  \/    \    |     (   /   â€¾â€¾\  
   /          \   |  |\  \ |  (â€¾)  | 
  / __________ \  |__| \__\ \_____/ .io

  execution: local
     script: test.js
     output: -

  scenarios: (100.00%) 1 scenario, 30 max VUs, 1m30s max duration (incl. graceful stop):
           * default: 30 looping VUs for 1m0s (gracefulStop: 30s)


     data_received..................: 849 kB 14 kB/s
     data_sent......................: 129 kB 2.1 kB/s
     http_req_blocked...............: avg=725.74Âµs min=709ns    med=5.89Âµs   max=38.68ms  p(90)=15.41Âµs  p(95)=24.4Âµs  
     http_req_connecting............: avg=605.88Âµs min=0s       med=0s       max=32.63ms  p(90)=0s       p(95)=0s      
     http_req_duration..............: avg=152.26ms min=112.94ms med=128.9ms  max=500.83ms p(90)=209.28ms p(95)=245.09ms
       { expected_response:true }...: avg=152.26ms min=112.94ms med=128.9ms  max=500.83ms p(90)=209.28ms p(95)=245.09ms
     http_req_failed................: 0.00%  âœ“ 0         âœ— 1572
     http_req_receiving.............: avg=622.21Âµs min=6.45Âµs   med=106.81Âµs max=114.73ms p(90)=1.25ms   p(95)=1.83ms  
     http_req_sending...............: avg=46.68Âµs  min=2.58Âµs   med=22.43Âµs  max=4.61ms   p(90)=76.31Âµs  p(95)=146.04Âµs
     http_req_tls_handshaking.......: avg=0s       min=0s       med=0s       max=0s       p(90)=0s       p(95)=0s      
     http_req_waiting...............: avg=151.59ms min=112.6ms  med=127.89ms max=500.43ms p(90)=208.39ms p(95)=244.85ms
     http_reqs......................: 1572   25.721444/s
     iteration_duration.............: avg=1.15s    min=1.11s    med=1.13s    max=1.53s    p(90)=1.21s    p(95)=1.24s   
     iterations.....................: 1572   25.721444/s
     vus............................: 2      min=2       max=30
     vus_max........................: 30     min=30      max=30


running (1m01.1s), 00/30 VUs, 1572 complete and 0 interrupted iterations
default âœ“ [======================================] 30 VUs  1m0s
vscode âžœ /workspaces/terraform-multi-cluster-gateways (main) $ 
```

### Result Confirmation
Cloud Monitoring ã® Log Analytics ã§ container ã® log ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¦ã¿ã¾ã™ã€‚

```sql
SELECT
  JSON_VALUE(resource.labels.location) AS cluster_location,
  COUNT(*) AS cnt
FROM
  `sandbox-mc-gateway.global._Default._AllLogs`
WHERE
  resource.type="k8s_container"
  AND timestamp >= TIMESTAMP("2023-11-30 13:03:00", "Asia/Tokyo")
  AND timestamp <= TIMESTAMP("2023-11-30 13:06:00", "Asia/Tokyo")
GROUP BY
  cluster_location
```

ä¸€å¿œã€æŒ¯ã‚Šåˆ†ã‘ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚west å´ã«å¯„ã£ã¦ã¾ã™ãŒã€‚
```bash
[
  {
    "id": "ROW_fcde01ba_0000000000",
    "cluster_location": "us-west1-a",
    "cnt": 15369
  },
  {
    "id": "ROW_fcde01ba_0000000001",
    "cluster_location": "us-east1-b",
    "cnt": 583
  }
]
```

Terraform ã§ code åŒ–ã—ã‚ˆã†ã¨æ€ã„ã¾ã—ãŸãŒã€æ­£æœˆã®æš‡ãªæ™‚ã«ã‚„ã‚Šã¾ã™ã€‚

ä»Šã®æ°—åˆ†ã¯ Rust ã«å…¨æŒ¯ã‚Šã®ãŸã‚ã€‚

Gateway ã«é–¢ã™ã‚‹æ¤œè¨¼ã¯ä»¥ä¸Šã§ã™ã€‚

ã“ã®æŠ•ç¨¿ã‚’ã¿ã¦ä½•ã‹å¾—ã‚‰ã‚ŒãŸæ–¹ã¯ã€ã„ã„ã­ â¤ï¸ ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

ãã‚Œã§ã¯ã€æ¬¡å›žã®ã‚¢ãƒ‰ã‚«ãƒ¬ã§ãŠä¼šã„ã—ã¾ã—ã‚‡ã†ã€‚ðŸ‘‹

[^1]: https://cloud.google.com/kubernetes-engine/docs/how-to/enabling-multi-cluster-gateways#restrictions_and_limitations
[^2]: https://k6.io/docs/
[^3]: https://cloud.google.com/kubernetes-engine/docs/how-to/deploying-multi-cluster-gateways
[^4]: https://cloud.google.com/kubernetes-engine/docs/how-to/enabling-multi-cluster-gateways
